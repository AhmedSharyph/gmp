<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Child Nutrition Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-center">ðŸ§’ Child Nutrition & Growth Monitoring Dashboard</h1>

  <div class="flex justify-end mb-4 space-x-2">
    <button id="exportExcel" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Export Excel</button>
    <button id="exportPDF" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Export PDF</button>
    <button id="toggleTable" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Toggle Table</button>
  </div>

  <!-- Dashboard Cards -->
  <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

  <!-- Data Table -->
  <div id="dataTableContainer" class="hidden bg-white p-4 rounded shadow overflow-x-auto">
    <table id="dataTable" class="min-w-full border border-gray-300"></table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzrq5jF8l3ClBCAjg2Yj5OVp1mMw4jQrysJ45fwiWaINy8miV2Gd6vr0MYedIDWyJjhGQ/exec"; // <-- replace with your Apps Script URL
let rawData = [];

// Fetch data from Apps Script
async function fetchData() {
  try {
    const res = await fetch(API_URL);
    rawData = await res.json();
    if (!Array.isArray(rawData)) rawData = [];
    renderDashboard();
    renderTable();
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

// Render dashboard cards with charts
function renderDashboard() {
  const container = document.getElementById("dashboard");
  container.innerHTML = "";

  rawData.forEach((row, idx) => {
    // Card container
    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded shadow space-y-3";

    // Facility info
    const facilityInfo = document.createElement("div");
    facilityInfo.innerHTML = `<h2 class="font-semibold text-lg">${row.healthFacility || 'Facility ' + (idx+1)}</h2>
      <p><strong>Staff:</strong> ${row.staffName || '-'} | <strong>Title:</strong> ${row.staffTitle || '-'} | <strong>Contact:</strong> ${row.staffContact || '-'}</p>
      <p><strong>Training:</strong> ${row.training || '-'}</p>
      <p><strong>Children under 5:</strong> ${row.childrenUnder5 || 0}, <strong>Under 2:</strong> ${row.childrenUnder2 || 0}, <strong>Under 2 GMP:</strong> ${row.childrenUnder2GMP || 0}</p>`;
    card.appendChild(facilityInfo);

    // Nutrition chart
    const nutritionCanvas = document.createElement("canvas");
    nutritionCanvas.id = "chartNutrition" + idx;
    card.appendChild(nutritionCanvas);

    const labels5 = ["Underweight", "Stunted", "Wasted", "Overweight", "Obesity"];
    const data5 = [
      Number(row.underweight5 || 0),
      Number(row.stunted5 || 0),
      Number(row.wasted5 || 0),
      Number(row.overweight5 || 0),
      Number(row.obesity5 || 0)
    ];

    new Chart(nutritionCanvas.getContext("2d"), {
      type: "bar",
      data: {
        labels: labels5,
        datasets: [{
          label: "Children <5",
          data: data5,
          backgroundColor: ["#f87171","#fb923c","#facc15","#4ade80","#22d3ee"]
        }]
      },
      options: { responsive:true, plugins:{ legend:{display:true} } }
    });

    container.appendChild(card);
  });
}

// Render raw data table
function renderTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  if (!rawData.length) return;

  // Table header
  const headerRow = document.createElement("tr");
  Object.keys(rawData[0]).forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.className = "border px-2 py-1 bg-gray-200";
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  // Table rows
  rawData.forEach(row => {
    const tr = document.createElement("tr");
    Object.values(row).forEach(v => {
      const td = document.createElement("td");
      td.textContent = v;
      td.className = "border px-2 py-1";
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

// Toggle table visibility
document.getElementById("toggleTable").addEventListener("click", () => {
  document.getElementById("dataTableContainer").classList.toggle("hidden");
});

// Export Excel
document.getElementById("exportExcel").addEventListener("click", () => {
  const ws = XLSX.utils.json_to_sheet(rawData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "GMP Data");
  XLSX.writeFile(wb, "gmp_data.xlsx");
});

// Export PDF
document.getElementById("exportPDF").addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  rawData.forEach((row, i) => {
    doc.text(`Facility ${i+1}: ${row.healthFacility || '-'}`, 10, 10 + i*10);
  });
  doc.save("gmp_data.pdf");
});

// Initialize
fetchData();
</script>
</body>
</html>
