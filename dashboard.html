<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GMP Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
  <h1 class="text-2xl font-bold mb-6">ðŸ“Š Child Nutrition & Growth Monitoring Dashboard</h1>

  <!-- Facility Filter -->
  <div class="mb-6">
    <label class="block font-medium mb-1">Filter by Health Facility:</label>
    <select id="facilityFilter" class="border rounded p-2 w-full"></select>
  </div>

  <!-- Cards Container -->
  <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6"></div>

  <!-- Optional Table Toggle -->
  <button id="toggleTableBtn" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 hover:bg-blue-700">
    Show Data Table
  </button>

  <div class="overflow-x-auto hidden" id="tableWrapper">
    <table class="min-w-full border border-gray-300 text-sm">
      <thead class="bg-gray-200">
        <tr id="tableHeader"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzrq5jF8l3ClBCAjg2Yj5OVp1mMw4jQrysJ45fwiWaINy8miV2Gd6vr0MYedIDWyJjhGQ/exec";
let allData = [];

async function loadData() {
  try {
    const res = await fetch(API_URL);
    allData = await res.json();
    if (!Array.isArray(allData)) throw new Error("Invalid data format");

    populateFacilityFilter();
    renderCards(allData);
    renderTable(allData);
  } catch (err) {
    alert("Error loading data: " + err.message);
  }
}

function populateFacilityFilter() {
  const select = document.getElementById("facilityFilter");
  const facilities = [...new Set(allData.map(d => d['Name of health facilit']))].sort();

  select.innerHTML = `<option value="">All Facilities</option>`;
  facilities.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    select.appendChild(opt);
  });

  select.addEventListener("change", () => {
    const val = select.value;
    const filtered = val ? allData.filter(d => d['Name of health facilit'] === val) : allData;
    renderCards(filtered);
    renderTable(filtered);
  });
}

function renderCards(data) {
  const container = document.getElementById("summaryCards");
  container.innerHTML = "";
  if (!data.length) return;

  // Aggregate metrics
  const sumField = (field) => data.reduce((s,d)=>s+(Number(d[field])||0),0);
  const countYes = (field) => data.filter(d=>d[field]==="Yes").length;

  const metrics = [
    { title: "Children <5", value: sumField("How many children under five?") },
    { title: "Children <2", value: sumField("How many children under 2?") },
    { title: "Children <2 GMP", value: sumField("How many children under 2 years attending regular GMP?") },

    // Nutrition prevalence <5
    { title: "Underweight <5", value: sumField("Underweight") },
    { title: "Stunted <5", value: sumField("Stunted") },
    { title: "Wasted <5", value: sumField("Wasted") },
    { title: "Overweight <5", value: sumField("Overweight") },
    { title: "Obesity <5", value: sumField("Obesity") },

    // Nutrition prevalence <2
    { title: "Underweight <2", value: sumField("Underweight2") },
    { title: "Stunted <2", value: sumField("Stunted2") },
    { title: "Wasted <2", value: sumField("Wasted2") },
    { title: "Overweight <2", value: sumField("Overweight2") },
    { title: "Obesity <2", value: sumField("Obesity2") },

    // Growth monitoring practices
    { title: "Routine Growth Monitoring", value: countYes("Is growth monitoring routinely conducted?") },
    { title: "Nutrition Counseling Provided", value: countYes("Is nutrition counseling or IYCF provided during visits?") },
    { title: "Child Delays Identified", value: countYes("Any child identified with delays this year?") },
    { title: "Group Sessions Held", value: countYes("Was any group sessions held to parents this year?") },

    // Public health
    { title: "Health Promotion Conducted", value: countYes("Do you conduct health promotion, Community engagement or outreach activities?") }
  ];

  metrics.forEach(m => {
    const card = document.createElement("div");
    card.className = "bg-blue-100 p-4 rounded shadow text-center";
    card.innerHTML = `<div class="text-xl font-bold">${m.value}</div><div>${m.title}</div>`;
    container.appendChild(card);
  });
}

function renderTable(data) {
  const header = document.getElementById("tableHeader");
  const body = document.getElementById("tableBody");
  header.innerHTML = "";
  body.innerHTML = "";

  if (!data.length) return;

  Object.keys(data[0]).forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.className = "border px-2 py-1 text-left";
    header.appendChild(th);
  });

  data.forEach(row => {
    const tr = document.createElement("tr");
    Object.values(row).forEach(val => {
      const td = document.createElement("td");
      td.textContent = val;
      td.className = "border px-2 py-1";
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

document.getElementById("toggleTableBtn").addEventListener("click", () => {
  const wrapper = document.getElementById("tableWrapper");
  wrapper.classList.toggle("hidden");
  document.getElementById("toggleTableBtn").textContent =
    wrapper.classList.contains("hidden") ? "Show Data Table" : "Hide Data Table";
});

loadData();
</script>
</body>
</html>
